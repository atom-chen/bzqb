{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\framework\\net\\pomelo/assets\\framework\\net\\pomelo\\pomelo-client.js"],"names":["JS_WS_CLIENT_TYPE","JS_WS_CLIENT_VERSION","Proctocol","require","Package","Protocol","Message","window","sys","localStorage","RES_OK","RES_FAIL","RES_OLD_CLIENT","Object","create","o","F","prototype","root","pomelo","socket","reqId","handlers","routeMap","heartbeatInterval","heartbeatTimeout","nextHeartbeatTimeout","gapThreshold","heartbeatId","heartbeatTimeoutId","handshakeCallback","decode","encode","useCrypto","handshakeBuffer","type","version","connectcb","debug","msgcb","init","params","host","port","url","user","initWebSocket","onopen","event","obj","TYPE_HANDSHAKE","strencode","JSON","stringify","send","onmessage","processPackage","data","Date","now","onerror","cc","error","onclose","WebSocket","binaryType","clearListener","disconnect","close","log","clearTimeout","request","route","msg","sendMessage","console","notify","TYPE_REQUEST","TYPE_NOTIFY","protos","client","protobuf","compressRoute","dict","packet","TYPE_DATA","readyState","buffer","handler","heartbeat","TYPE_HEARTBEAT","setTimeout","heartbeatTimeoutCb","gap","handshake","parse","strdecode","code","handshakeInit","TYPE_HANDSHAKE_ACK","onData","id","body","deCompose","processMessage","onKick","TYPE_KICK","msgs","Array","isArray","i","length","processMessageBatch","l","server","abbrs","initData","encoderProtos","decoderProtos","module","exports"],"mappings":"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","file":"pomelo-client.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\framework\\net\\pomelo","sourcesContent":["(function () {\n  var JS_WS_CLIENT_TYPE = 'js-websocket';\n  var JS_WS_CLIENT_VERSION = '0.0.1';\n\n  var Proctocol = require(\"protocol\");\n  var Package = Protocol.Package;\n  var Message = Protocol.Message;\n\n  if (typeof (window) != \"undefined\" && typeof (sys) != 'undefined' && sys.localStorage) {\n    window.localStorage = sys.localStorage;\n  }\n\n  var RES_OK = 200;\n  var RES_FAIL = 500;\n  var RES_OLD_CLIENT = 501;\n\n  if (typeof Object.create !== 'function') {\n    Object.create = function (o) {\n      function F() { }\n      F.prototype = o;\n      return new F();\n    };\n  }\n\n  var root = window;\n  var pomelo = {};\n  root.pomelo = pomelo;\n  var socket = null;\n  var reqId = 0;\n  var handlers = {};\n  //Map from request id to route\n  var routeMap = {};\n\n  var heartbeatInterval = 0;\n  var heartbeatTimeout = 0;\n  var nextHeartbeatTimeout = 0;\n  var gapThreshold = 100;   // heartbeat gap threashold\n  var heartbeatId = null;\n  var heartbeatTimeoutId = null;\n\n  var handshakeCallback = null;\n\n  var decode = null;\n  var encode = null;\n\n  var useCrypto;\n\n  var handshakeBuffer = {\n    'sys': {\n      type: JS_WS_CLIENT_TYPE,\n      version: JS_WS_CLIENT_VERSION\n    },\n    'user': {\n    }\n  };\n\n\n  var connectcb = null;\n  var debug = false;\n  var msgcb = null;\n\n\n  pomelo.init = function (params) {\n\n    var host = params.host;\n    var port = params.port;\n    connectcb = params.connectcb;\n    debug = params.debug;\n    msgcb = params.msgcb;\n    var url = 'ws://' + host;\n    if (port) {\n      url += ':' + port;\n    }\n\n    handshakeBuffer.user = params.user;\n    handshakeCallback = params.handshakeCallback;\n    initWebSocket(url);\n  };\n\n  var initWebSocket = function (url) {\n    //无效地址不进行websocket链接\n    if (!url) {\n      return;\n    }\n    var onopen = function (event) {\n      var obj = Package.encode(Package.TYPE_HANDSHAKE, Protocol.strencode(JSON.stringify(handshakeBuffer)));\n      send(obj);\n    };\n    var onmessage = function (event) {\n      processPackage(Package.decode(event.data));\n      // new package arrived, update the heartbeat timeout\n      if (heartbeatTimeout) {\n        nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\n      }\n    };\n    var onerror = function (event) {\n      if (connectcb) {\n        connectcb('io-error', event);\n      }\n      cc.error('socket error: ', event);\n    };\n    var onclose = function (event) {\n      if (connectcb) {\n        connectcb('close', event);\n        connectcb('disconnect', event);\n      }\n      cc.error('socket close: ', event);\n    };\n    socket = new WebSocket(url);\n    socket.binaryType = 'arraybuffer';\n    socket.onopen = onopen;\n    socket.onmessage = onmessage;\n    socket.onerror = onerror;\n    socket.onclose = onclose;\n  };\n  pomelo.clearListener = function () {\n    connectcb = function () { };\n    msgcb = function () { };\n  }\n  pomelo.disconnect = function () {\n    if (socket) {\n      if (socket.disconnect) socket.disconnect();\n      if (socket.close) socket.close();\n      cc.log('disconnect');\n      socket = null;\n    }\n\n    if (heartbeatId) {\n      clearTimeout(heartbeatId);\n      heartbeatId = null;\n    }\n    if (heartbeatTimeoutId) {\n      clearTimeout(heartbeatTimeoutId);\n      heartbeatTimeoutId = null;\n    }\n  };\n\n  pomelo.request = function (route, msg) {\n\n    if (!route) {\n      return;\n    }\n\n    reqId++;\n    sendMessage(reqId, route, msg);\n    routeMap[reqId] = route;\n    console.log(\"routeMap=\", routeMap)\n  };\n\n  pomelo.notify = function (route, msg) {\n    msg = msg || {};\n    sendMessage(0, route, msg);\n  };\n\n  var sendMessage = function (reqId, route, msg) {\n    var type = reqId ? Message.TYPE_REQUEST : Message.TYPE_NOTIFY;\n\n    //compress message by protobuf\n    var protos = !!pomelo.data.protos ? pomelo.data.protos.client : {};\n    if (!!protos[route]) {\n      msg = protobuf.encode(route, msg);\n    } else {\n      msg = Protocol.strencode(JSON.stringify(msg));\n    }\n\n\n    var compressRoute = 0;\n    if (pomelo.dict && pomelo.dict[route]) {\n      route = pomelo.dict[route];\n      compressRoute = 1;\n    }\n\n    msg = Message.encode(reqId, type, compressRoute, route, msg);\n    var packet = Package.encode(Package.TYPE_DATA, msg);\n    send(packet);\n  };\n\n  var send = function (packet) {\n    //websocket已经可以发送才执行send,不然不做发送websocket\n    if (socket && typeof (socket) == 'object' && socket.readyState === 1) {\n      socket.send(packet.buffer);\n    }\n    else {\n      return;\n    }\n  };\n\n\n  var handler = {};\n\n  var heartbeat = function (data) {\n    if (!heartbeatInterval) {\n      // no heartbeat\n      return;\n    }\n\n    var obj = Package.encode(Package.TYPE_HEARTBEAT);\n    if (heartbeatTimeoutId) {\n      clearTimeout(heartbeatTimeoutId);\n      heartbeatTimeoutId = null;\n    }\n\n    if (heartbeatId) {\n      // already in a heartbeat interval\n      return;\n    }\n\n    heartbeatId = setTimeout(function () {\n      heartbeatId = null;\n      send(obj);\n\n      nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, heartbeatTimeout);\n    }, heartbeatInterval);\n  };\n\n  var heartbeatTimeoutCb = function () {\n    var gap = nextHeartbeatTimeout - Date.now();\n    if (gap > gapThreshold) {\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, gap);\n    } else {\n      cc.error('server heartbeat timeout');\n      connectcb('heartbeat timeout');\n      pomelo.disconnect();\n    }\n  };\n\n  var handshake = function (data) {\n    data = JSON.parse(Protocol.strdecode(data));\n    if (data.code === RES_OLD_CLIENT) {\n      connectcb('error', 'client version not fullfill');\n      return;\n    }\n\n    if (data.code !== RES_OK) {\n      connectcb('error', 'handshake fail');\n      return;\n    }\n\n    handshakeInit(data);\n\n    var obj = Package.encode(Package.TYPE_HANDSHAKE_ACK);\n    send(obj);\n\n    connectcb(\"connect\")\n  };\n\n  var onData = function (data) {\n    //probuff decode\n    var msg = Message.decode(data);\n\n    if (msg.id > 0) {\n      msg.route = routeMap[msg.id];\n      delete routeMap[msg.id];\n      if (!msg.route) {\n        return;\n      }\n    }\n\n    msg.body = deCompose(msg);\n\n    processMessage(pomelo, msg);\n  };\n\n  var onKick = function (data) {\n    data = JSON.parse(Protocol.strdecode(data));\n    connectcb('onKick', data);\n  };\n\n  handlers[Package.TYPE_HANDSHAKE] = handshake;\n  handlers[Package.TYPE_HEARTBEAT] = heartbeat;\n  handlers[Package.TYPE_DATA] = onData;\n  handlers[Package.TYPE_KICK] = onKick;\n\n  var processPackage = function (msgs) {\n    if (Array.isArray(msgs)) {\n      for (var i = 0; i < msgs.length; i++) {\n        var msg = msgs[i];\n        handlers[msg.type](msg.body);\n      }\n    } else {\n      handlers[msgs.type](msgs.body);\n    }\n  };\n\n  var processMessage = function (pomelo, msg) {\n    let code = null;\n    if (msg.body) {\n      code = msg.body.code;\n    }\n    msgcb(msg.route, code, msg.body);\n    return;\n  };\n\n  var processMessageBatch = function (pomelo, msgs) {\n    for (var i = 0, l = msgs.length; i < l; i++) {\n      processMessage(pomelo, msgs[i]);\n    }\n  };\n\n  var deCompose = function (msg) {\n    var protos = !!pomelo.data.protos ? pomelo.data.protos.server : {};\n    var abbrs = pomelo.data.abbrs;\n    var route = msg.route;\n\n    //Decompose route from dict\n    if (msg.compressRoute) {\n      if (!abbrs[route]) {\n        return {};\n      }\n\n      route = msg.route = abbrs[route];\n    }\n    if (!!protos[route]) {\n      return protobuf.decode(route, msg.body);\n    } else {\n      return JSON.parse(Protocol.strdecode(msg.body));\n    }\n\n    return msg;\n  };\n\n  var handshakeInit = function (data) {\n    if (data.sys && data.sys.heartbeat) {\n      heartbeatInterval = data.sys.heartbeat * 1000;   // heartbeat interval\n      heartbeatTimeout = heartbeatInterval * 2;        // max heartbeat timeout\n    } else {\n      heartbeatInterval = 0;\n      heartbeatTimeout = 0;\n    }\n\n    initData(data);\n\n    if (typeof handshakeCallback === 'function') {\n      handshakeCallback(data.user);\n    }\n  };\n\n  //Initilize data used in pomelo client\n  var initData = function (data) {\n    if (!data || !data.sys) {\n      return;\n    }\n    pomelo.data = pomelo.data || {};\n    var dict = data.sys.dict;\n    var protos = data.sys.protos;\n\n    //Init compress dict\n    if (dict) {\n      pomelo.data.dict = dict;\n      pomelo.data.abbrs = {};\n\n      for (var route in dict) {\n        pomelo.data.abbrs[dict[route]] = route;\n      }\n    }\n\n    //Init protobuf protos\n    if (protos) {\n      pomelo.data.protos = {\n        server: protos.server || {},\n        client: protos.client || {}\n      };\n      if (!!protobuf) {\n        protobuf.init({ encoderProtos: protos.client, decoderProtos: protos.server });\n      }\n    }\n  };\n\n  module.exports = pomelo;\n})();\n"]}