{"version":3,"sources":["..\\..\\..\\..\\..\\..\\..\\assets\\modules\\game\\script\\lib/assets\\modules\\game\\script\\lib\\hkpomelo.js"],"names":["Emitter","obj","mixin","key","prototype","on","addEventListener","event","fn","_callbacks","push","once","self","off","apply","arguments","removeListener","removeAllListeners","removeEventListener","length","callbacks","cb","i","splice","emit","args","slice","call","len","listeners","hasListeners","window","EventEmitter","exports","ByteArray","global","Protocol","PKG_HEAD_BYTES","MSG_FLAG_BYTES","MSG_ROUTE_CODE_BYTES","MSG_ID_MAX_BYTES","MSG_ROUTE_LEN_BYTES","MSG_ROUTE_CODE_MAX","MSG_COMPRESS_ROUTE_MASK","MSG_TYPE_MASK","Package","Message","TYPE_HANDSHAKE","TYPE_HANDSHAKE_ACK","TYPE_HEARTBEAT","TYPE_DATA","TYPE_KICK","TYPE_REQUEST","TYPE_NOTIFY","TYPE_RESPONSE","TYPE_PUSH","strencode","str","byteArray","offset","charCode","charCodeAt","codes","j","_buffer","copyArray","strdecode","buffer","bytes","array","end","String","fromCharCode","encode","type","body","index","decode","rs","id","compressRoute","route","msg","idBytes","msgHasId","caculateMsgIdBytes","msgLen","msgHasRoute","Error","encodeMsgFlag","encodeMsgId","encodeMsgRoute","encodeMsgBody","bytesLen","byteLength","flag","m","parseInt","Math","pow","routeLen","bodyLen","dest","doffset","src","soffset","copy","tmp","next","floor","module","Buffer","Uint8Array","Protobuf","init","opts","encoder","encoderProtos","decoder","decoderProtos","protobuf","constants","TYPES","uInt32","sInt32","int32","double","string","message","float","Util","util","isSimpleType","Codec","codec","ArrayBuffer","float32Array","Float32Array","float64Array","Float64Array","uInt8Array","encodeUInt32","n","isNaN","result","encodeSInt32","abs","decodeUInt32","decodeSInt32","encodeFloat","decodeFloat","encodeDouble","subarray","decodeDouble","encodeStr","code","encode2UTF8","decodeStr","codeLength","MsgEncoder","constant","protos","checkMsg","JSON","stringify","encodeMsg","name","proto","option","console","warn","__messages","writeBytes","encodeTag","tag","encodeProp","encodeArray","value","tmpBuffer","MsgDecoder","setProtos","buf","decodeMsg","head","getHead","__tags","decodeProp","decodeArray","isFinish","peekHead","getBytes","peekBytes","pos","b","pomelo","JS_WS_CLIENT_TYPE","JS_WS_CLIENT_VERSION","decodeIO_protobuf","decodeIO_encoder","decodeIO_decoder","rsa","disconnectCb","sys","localStorage","RES_OK","RES_FAIL","RES_OLD_CLIENT","Object","create","o","F","root","socket","reqId","handlers","routeMap","dict","abbrs","serverProtos","clientProtos","protoVersion","heartbeatInterval","heartbeatTimeout","nextHeartbeatTimeout","gapThreshold","heartbeatId","heartbeatTimeoutId","handshakeCallback","reconnect","reconncetTimer","reconnectUrl","reconnectAttempts","reconnectionDelay","DEFAULT_MAX_RECONNECT_ATTEMPTS","useCrypto","handshakeBuffer","version","initCallback","params","host","port","defaultEncode","defaultDecode","wsType","url","user","encrypt","generate","data","rsa_n","toString","rsa_e","e","connect","deCompose","lookup","Builder","build","encodeNB","log","maxReconnectAttempts","getItem","parse","server","client","loadJson","onopen","reset","send","onmessage","processPackage","Date","now","onerror","error","onclose","setTimeout","WebSocket","binaryType","disconnect","close","clearTimeout","request","sendMessage","notify","sig","signString","packet","handler","heartbeat","heartbeatTimeoutCb","gap","handshake","handshakeInit","onData","processMessage","onKick","msgs","Array","isArray","processMessageBatch","l","initData","setItem"],"mappings":"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","file":"hkpomelo.js","sourceRoot":"..\\..\\..\\..\\..\\..\\..\\assets\\modules\\game\\script\\lib","sourcesContent":["\n(function(){\n  function Emitter(obj) {\n    if (obj) return mixin(obj);\n  };\n\n  function mixin(obj) {\n    for (var key in Emitter.prototype) {\n      obj[key] = Emitter.prototype[key];\n    }\n    return obj;\n  }\n\n  Emitter.prototype.on =\n  Emitter.prototype.addEventListener = function(event, fn){\n    this._callbacks = this._callbacks || {};\n    (this._callbacks[event] = this._callbacks[event] || [])\n      .push(fn);\n    return this;\n  };\n\n  Emitter.prototype.once = function(event, fn){\n    var self = this;\n    this._callbacks = this._callbacks || {};\n\n    function on() {\n      self.off(event, on);\n      fn.apply(this, arguments);\n    }\n\n    on.fn = fn;\n    this.on(event, on);\n    return this;\n  };\n\n  Emitter.prototype.off =\n  Emitter.prototype.removeListener =\n  Emitter.prototype.removeAllListeners =\n  Emitter.prototype.removeEventListener = function(event, fn){\n    this._callbacks = this._callbacks || {};\n\n    if (0 == arguments.length) {\n      this._callbacks = {};\n      return this;\n    }\n\n    var callbacks = this._callbacks[event];\n    if (!callbacks) return this;\n\n    if (1 == arguments.length) {\n      delete this._callbacks[event];\n      return this;\n    }\n\n    var cb;\n    for (var i = 0; i < callbacks.length; i++) {\n      cb = callbacks[i];\n      if (cb === fn || cb.fn === fn) {\n        callbacks.splice(i, 1);\n        break;\n      }\n    }\n    return this;\n  };\n\n  Emitter.prototype.emit = function(event){\n    this._callbacks = this._callbacks || {};\n    var args = [].slice.call(arguments, 1)\n      , callbacks = this._callbacks[event];\n\n    if (callbacks) {\n      callbacks = callbacks.slice(0);\n      for (var i = 0, len = callbacks.length; i < len; ++i) {\n        callbacks[i].apply(this, args);\n      }\n    }\n\n    return this;\n  };\n\n  Emitter.prototype.listeners = function(event){\n    this._callbacks = this._callbacks || {};\n    return this._callbacks[event] || [];\n  };\n  Emitter.prototype.hasListeners = function(event){\n    return !! this.listeners(event).length;\n  };\n\n  if(typeof(window) != \"undefined\") {\n    window.EventEmitter = Emitter;\n  }\n\n})();\n\n(function (exports, ByteArray, global) {\n  var Protocol = exports;\n\n  var PKG_HEAD_BYTES = 4;\n  var MSG_FLAG_BYTES = 1;\n  var MSG_ROUTE_CODE_BYTES = 2;\n  var MSG_ID_MAX_BYTES = 5;\n  var MSG_ROUTE_LEN_BYTES = 1;\n\n  var MSG_ROUTE_CODE_MAX = 0xffff;\n\n  var MSG_COMPRESS_ROUTE_MASK = 0x1;\n  var MSG_TYPE_MASK = 0x7;\n\n  var Package = Protocol.Package = {};\n  var Message = Protocol.Message = {};\n\n  Package.TYPE_HANDSHAKE = 1;\n  Package.TYPE_HANDSHAKE_ACK = 2;\n  Package.TYPE_HEARTBEAT = 3;\n  Package.TYPE_DATA = 4;\n  Package.TYPE_KICK = 5;\n\n  Message.TYPE_REQUEST = 0;\n  Message.TYPE_NOTIFY = 1;\n  Message.TYPE_RESPONSE = 2;\n  Message.TYPE_PUSH = 3;\n\n  Protocol.strencode = function(str) {\n    var byteArray = new ByteArray(str.length * 3);\n    var offset = 0;\n    for(var i = 0; i < str.length; i++){\n      var charCode = str.charCodeAt(i);\n      var codes = null;\n      if(charCode <= 0x7f){\n        codes = [charCode];\n      }else if(charCode <= 0x7ff){\n        codes = [0xc0|(charCode>>6), 0x80|(charCode & 0x3f)];\n      }else{\n        codes = [0xe0|(charCode>>12), 0x80|((charCode & 0xfc0)>>6), 0x80|(charCode & 0x3f)];\n      }\n      for(var j = 0; j < codes.length; j++){\n        byteArray[offset] = codes[j];\n        ++offset;\n      }\n    }\n    var _buffer = new ByteArray(offset);\n    copyArray(_buffer, 0, byteArray, 0, offset);\n    return _buffer;\n  };\n\n  Protocol.strdecode = function(buffer) {\n    var bytes = new ByteArray(buffer);\n    var array = [];\n    var offset = 0;\n    var charCode = 0;\n    var end = bytes.length;\n    while(offset < end){\n      if(bytes[offset] < 128){\n        charCode = bytes[offset];\n        offset += 1;\n      }else if(bytes[offset] < 224){\n        charCode = ((bytes[offset] & 0x3f)<<6) + (bytes[offset+1] & 0x3f);\n        offset += 2;\n      }else{\n        charCode = ((bytes[offset] & 0x0f)<<12) + ((bytes[offset+1] & 0x3f)<<6) + (bytes[offset+2] & 0x3f);\n        offset += 3;\n      }\n      array.push(charCode);\n    }\n    return String.fromCharCode.apply(null, array);\n  };\n\n  Package.encode = function(type, body){\n    var length = body ? body.length : 0;\n    var buffer = new ByteArray(PKG_HEAD_BYTES + length);\n    var index = 0;\n    buffer[index++] = type & 0xff;\n    buffer[index++] = (length >> 16) & 0xff;\n    buffer[index++] = (length >> 8) & 0xff;\n    buffer[index++] = length & 0xff;\n    if(body) {\n      copyArray(buffer, index, body, 0, length);\n    }\n    return buffer;\n  };\n\n \n  Package.decode = function(buffer){\n    var offset = 0;\n    var bytes = new ByteArray(buffer);\n    var length = 0;\n    var rs = [];\n    while(offset < bytes.length) {\n      var type = bytes[offset++];\n      length = ((bytes[offset++]) << 16 | (bytes[offset++]) << 8 | bytes[offset++]) >>> 0;\n      var body = length ? new ByteArray(length) : null;\n      copyArray(body, 0, bytes, offset, length);\n      offset += length;\n      rs.push({'type': type, 'body': body});\n    }\n    return rs.length === 1 ? rs[0]: rs;\n  };\n\n  Message.encode = function(id, type, compressRoute, route, msg){\n    // caculate message max length\n    var idBytes = msgHasId(type) ? caculateMsgIdBytes(id) : 0;\n    var msgLen = MSG_FLAG_BYTES + idBytes;\n\n    if(msgHasRoute(type)) {\n      if(compressRoute) {\n        if(typeof route !== 'number'){\n          throw new Error('error flag for number route!');\n        }\n        msgLen += MSG_ROUTE_CODE_BYTES;\n      } else {\n        msgLen += MSG_ROUTE_LEN_BYTES;\n        if(route) {\n          route = Protocol.strencode(route);\n          if(route.length>255) {\n            throw new Error('route maxlength is overflow');\n          }\n          msgLen += route.length;\n        }\n      }\n    }\n\n    if(msg) {\n      msgLen += msg.length;\n    }\n\n    var buffer = new ByteArray(msgLen);\n    var offset = 0;\n\n    // add flag\n    offset = encodeMsgFlag(type, compressRoute, buffer, offset);\n\n    // add message id\n    if(msgHasId(type)) {\n      offset = encodeMsgId(id, buffer, offset);\n    }\n\n    // add route\n    if(msgHasRoute(type)) {\n      offset = encodeMsgRoute(compressRoute, route, buffer, offset);\n    }\n\n    // add body\n    if(msg) {\n      offset = encodeMsgBody(msg, buffer, offset);\n    }\n\n    return buffer;\n  };\n\n  \n  Message.decode = function(buffer) {\n    var bytes =  new ByteArray(buffer);\n    var bytesLen = bytes.length || bytes.byteLength;\n    var offset = 0;\n    var id = 0;\n    var route = null;\n\n    // parse flag\n    var flag = bytes[offset++];\n    var compressRoute = flag & MSG_COMPRESS_ROUTE_MASK;\n    var type = (flag >> 1) & MSG_TYPE_MASK;\n\n    // parse id\n    if(msgHasId(type)) {\n      var m = parseInt(bytes[offset]);\n      var i = 0;\n      do{\n        var m = parseInt(bytes[offset]);\n        id = id + ((m & 0x7f) * Math.pow(2,(7*i)));\n        offset++;\n        i++;\n      }while(m >= 128);\n    }\n\n    // parse route\n    if(msgHasRoute(type)) {\n      if(compressRoute) {\n        route = (bytes[offset++]) << 8 | bytes[offset++];\n      } else {\n        var routeLen = bytes[offset++];\n        if(routeLen) {\n          route = new ByteArray(routeLen);\n          copyArray(route, 0, bytes, offset, routeLen);\n          route = Protocol.strdecode(route);\n        } else {\n          route = '';\n        }\n        offset += routeLen;\n      }\n    }\n\n    // parse body\n    var bodyLen = bytesLen - offset;\n    var body = new ByteArray(bodyLen);\n\n    copyArray(body, 0, bytes, offset, bodyLen);\n\n    return {'id': id, 'type': type, 'compressRoute': compressRoute,\n            'route': route, 'body': body};\n  };\n\n  var copyArray = function(dest, doffset, src, soffset, length) {\n    if('function' === typeof src.copy) {\n      // Buffer\n      src.copy(dest, doffset, soffset, soffset + length);\n    } else {\n      // Uint8Array\n      for(var index=0; index<length; index++){\n        dest[doffset++] = src[soffset++];\n      }\n    }\n  };\n\n  var msgHasId = function(type) {\n    return type === Message.TYPE_REQUEST || type === Message.TYPE_RESPONSE;\n  };\n\n  var msgHasRoute = function(type) {\n    return type === Message.TYPE_REQUEST || type === Message.TYPE_NOTIFY ||\n           type === Message.TYPE_PUSH;\n  };\n\n  var caculateMsgIdBytes = function(id) {\n    var len = 0;\n    do {\n      len += 1;\n      id >>= 7;\n    } while(id > 0);\n    return len;\n  };\n\n  var encodeMsgFlag = function(type, compressRoute, buffer, offset) {\n    if(type !== Message.TYPE_REQUEST && type !== Message.TYPE_NOTIFY &&\n       type !== Message.TYPE_RESPONSE && type !== Message.TYPE_PUSH) {\n      throw new Error('unkonw message type: ' + type);\n    }\n\n    buffer[offset] = (type << 1) | (compressRoute ? 1 : 0);\n\n    return offset + MSG_FLAG_BYTES;\n  };\n\n  var encodeMsgId = function(id, buffer, offset) {\n    do{\n      var tmp = id % 128;\n      var next = Math.floor(id/128);\n\n      if(next !== 0){\n        tmp = tmp + 128;\n      }\n      buffer[offset++] = tmp;\n\n      id = next;\n    } while(id !== 0);\n\n    return offset;\n  };\n\n  var encodeMsgRoute = function(compressRoute, route, buffer, offset) {\n    if (compressRoute) {\n      if(route > MSG_ROUTE_CODE_MAX){\n        throw new Error('route number is overflow');\n      }\n\n      buffer[offset++] = (route >> 8) & 0xff;\n      buffer[offset++] = route & 0xff;\n    } else {\n      if(route) {\n        buffer[offset++] = route.length & 0xff;\n        copyArray(buffer, offset, route, 0, route.length);\n        offset += route.length;\n      } else {\n        buffer[offset++] = 0;\n      }\n    }\n\n    return offset;\n  };\n\n  var encodeMsgBody = function(msg, buffer, offset) {\n    copyArray(buffer, offset, msg, 0, msg.length);\n    return offset + msg.length;\n  };\n\n  // module.exports = Protocol;\n  if(typeof(window) != \"undefined\") {\n    window.Protocol = Protocol;\n  }\n})(typeof(window)==\"undefined\" ? module.exports : ({}),typeof(window)==\"undefined\"  ? Buffer : Uint8Array, this);\n\n\n(function (exports, global){\n  var Protobuf = exports;\n\n  Protobuf.init = function(opts){\n    //On the serverside, use serverProtos to encode messages send to client\n    Protobuf.encoder.init(opts.encoderProtos);\n\n    //On the serverside, user clientProtos to decode messages receive from clients\n    Protobuf.decoder.init(opts.decoderProtos);\n  };\n\n  Protobuf.encode = function(key, msg){\n    return Protobuf.encoder.encode(key, msg);\n  };\n\n  Protobuf.decode = function(key, msg){\n    return Protobuf.decoder.decode(key, msg);\n  };\n\n  // exports to support for components\n  // module.exports = Protobuf;\n  if(typeof(window) != \"undefined\") {\n    window.protobuf = Protobuf;\n  }\n  \n})(typeof(window) == \"undefined\" ? module.exports : ({}), this);\n\n/**\n * constants\n */\n(function (exports, global){\n  var constants = exports.constants = {};\n\n  constants.TYPES = {\n    uInt32 : 0,\n    sInt32 : 0,\n    int32 : 0,\n    double : 1,\n    string : 2,\n    message : 2,\n    float : 5\n  };\n\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\n\n/**\n * util module\n */\n(function (exports, global){\n\n  var Util = exports.util = {};\n\n  Util.isSimpleType = function(type){\n    return ( type === 'uInt32' ||\n             type === 'sInt32' ||\n             type === 'int32'  ||\n             type === 'uInt64' ||\n             type === 'sInt64' ||\n             type === 'float'  ||\n             type === 'double' );\n  };\n\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\n\n/**\n * codec module\n */\n(function (exports, global){\n\n  var Codec = exports.codec = {};\n\n  var buffer = new ArrayBuffer(8);\n  var float32Array = new Float32Array(buffer);\n  var float64Array = new Float64Array(buffer);\n  var uInt8Array = new Uint8Array(buffer);\n\n  Codec.encodeUInt32 = function(n){\n    var n = parseInt(n);\n    if(isNaN(n) || n < 0){\n      return null;\n    }\n\n    var result = [];\n    do{\n      var tmp = n % 128;\n      var next = Math.floor(n/128);\n\n      if(next !== 0){\n        tmp = tmp + 128;\n      }\n      result.push(tmp);\n      n = next;\n    }while(n !== 0);\n\n    return result;\n  };\n\n  Codec.encodeSInt32 = function(n){\n    var n = parseInt(n);\n    if(isNaN(n)){\n      return null;\n    }\n    n = n<0?(Math.abs(n)*2-1):n*2;\n\n    return Codec.encodeUInt32(n);\n  };\n\n  Codec.decodeUInt32 = function(bytes){\n    var n = 0;\n\n    for(var i = 0; i < bytes.length; i++){\n      var m = parseInt(bytes[i]);\n      n = n + ((m & 0x7f) * Math.pow(2,(7*i)));\n      if(m < 128){\n        return n;\n      }\n    }\n\n    return n;\n  };\n\n  Codec.decodeSInt32 = function(bytes){\n    var n = this.decodeUInt32(bytes);\n    var flag = ((n%2) === 1)?-1:1;\n\n    n = ((n%2 + n)/2)*flag;\n\n    return n;\n  };\n\n  Codec.encodeFloat = function(float){\n    float32Array[0] = float;\n    return uInt8Array;\n  };\n\n  Codec.decodeFloat = function(bytes, offset){\n    if(!bytes || bytes.length < (offset + 4)){\n      return null;\n    }\n\n    for(var i = 0; i < 4; i++){\n      uInt8Array[i] = bytes[offset + i];\n    }\n\n    return float32Array[0];\n  };\n\n  Codec.encodeDouble = function(double){\n    float64Array[0] = double;\n    return uInt8Array.subarray(0, 8);\n  };\n\n  Codec.decodeDouble = function(bytes, offset){\n    if(!bytes || bytes.length < (offset + 8)){\n      return null;\n    }\n\n    for(var i = 0; i < 8; i++){\n      uInt8Array[i] = bytes[offset + i];\n    }\n\n    return float64Array[0];\n  };\n\n  Codec.encodeStr = function(bytes, offset, str){\n    for(var i = 0; i < str.length; i++){\n      var code = str.charCodeAt(i);\n      var codes = encode2UTF8(code);\n\n      for(var j = 0; j < codes.length; j++){\n        bytes[offset] = codes[j];\n        offset++;\n      }\n    }\n\n    return offset;\n  };\n\n  /**\n   * Decode string from utf8 bytes\n   */\n  Codec.decodeStr = function(bytes, offset, length){\n    var array = [];\n    var end = offset + length;\n\n    while(offset < end){\n      var code = 0;\n\n      if(bytes[offset] < 128){\n        code = bytes[offset];\n\n        offset += 1;\n      }else if(bytes[offset] < 224){\n        code = ((bytes[offset] & 0x3f)<<6) + (bytes[offset+1] & 0x3f);\n        offset += 2;\n      }else{\n        code = ((bytes[offset] & 0x0f)<<12) + ((bytes[offset+1] & 0x3f)<<6) + (bytes[offset+2] & 0x3f);\n        offset += 3;\n      }\n\n      array.push(code);\n\n    }\n\n    var str = '';\n    for(var i = 0; i < array.length;){\n      str += String.fromCharCode.apply(null, array.slice(i, i + 10000));\n      i += 10000;\n    }\n\n    return str;\n  };\n\n  /**\n   * Return the byte length of the str use utf8\n   */\n  Codec.byteLength = function(str){\n    if(typeof(str) !== 'string'){\n      return -1;\n    }\n\n    var length = 0;\n\n    for(var i = 0; i < str.length; i++){\n      var code = str.charCodeAt(i);\n      length += codeLength(code);\n    }\n\n    return length;\n  };\n\n  /**\n   * Encode a unicode16 char code to utf8 bytes\n   */\n  function encode2UTF8(charCode){\n    if(charCode <= 0x7f){\n      return [charCode];\n    }else if(charCode <= 0x7ff){\n      return [0xc0|(charCode>>6), 0x80|(charCode & 0x3f)];\n    }else{\n      return [0xe0|(charCode>>12), 0x80|((charCode & 0xfc0)>>6), 0x80|(charCode & 0x3f)];\n    }\n  }\n\n  function codeLength(code){\n    if(code <= 0x7f){\n      return 1;\n    }else if(code <= 0x7ff){\n      return 2;\n    }else{\n      return 3;\n    }\n  }\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\n\n/**\n * encoder module\n */\n(function (exports, global){\n\n  var protobuf = exports;\n  var MsgEncoder = exports.encoder = {};\n\n  var codec = protobuf.codec;\n  var constant = protobuf.constants;\n  var util = protobuf.util;\n\n  MsgEncoder.init = function(protos){\n    this.protos = protos || {};\n  };\n\n  MsgEncoder.encode = function(route, msg){\n    //Get protos from protos map use the route as key\n    var protos = this.protos[route];\n\n    //Check msg\n    if(!checkMsg(msg, protos)){\n      return null;\n    }\n\n    //Set the length of the buffer 2 times bigger to prevent overflow\n    var length = codec.byteLength(JSON.stringify(msg));\n\n    //Init buffer and offset\n    var buffer = new ArrayBuffer(length);\n    var uInt8Array = new Uint8Array(buffer);\n    var offset = 0;\n\n    if(!!protos){\n      offset = encodeMsg(uInt8Array, offset, protos, msg);\n      if(offset > 0){\n        return uInt8Array.subarray(0, offset);\n      }\n    }\n\n    return null;\n  };\n\n  /**\n   * Check if the msg follow the defination in the protos\n   */\n  function checkMsg(msg, protos){\n    if(!protos){\n      return false;\n    }\n\n    for(var name in protos){\n      var proto = protos[name];\n\n      //All required element must exist\n      switch(proto.option){\n        case 'required' :\n          if(typeof(msg[name]) === 'undefined'){\n            console.warn('no property exist for required! name: %j, proto: %j, msg: %j', name, proto, msg);\n            return false;\n          }\n        case 'optional' :\n          if(typeof(msg[name]) !== 'undefined'){\n            var message = protos.__messages[proto.type] || MsgEncoder.protos['message ' + proto.type];\n            if(!!message && !checkMsg(msg[name], message)){\n              console.warn('inner proto error! name: %j, proto: %j, msg: %j', name, proto, msg);\n              return false;\n            }\n          }\n        break;\n        case 'repeated' :\n          //Check nest message in repeated elements\n          var message = protos.__messages[proto.type] || MsgEncoder.protos['message ' + proto.type];\n          if(!!msg[name] && !!message){\n            for(var i = 0; i < msg[name].length; i++){\n              if(!checkMsg(msg[name][i], message)){\n                return false;\n              }\n            }\n          }\n        break;\n      }\n    }\n\n    return true;\n  }\n\n  function encodeMsg(buffer, offset, protos, msg){\n    for(var name in msg){\n      if(!!protos[name]){\n        var proto = protos[name];\n\n        switch(proto.option){\n          case 'required' :\n          case 'optional' :\n            offset = writeBytes(buffer, offset, encodeTag(proto.type, proto.tag));\n            offset = encodeProp(msg[name], proto.type, offset, buffer, protos);\n          break;\n          case 'repeated' :\n            if(msg[name].length > 0){\n              offset = encodeArray(msg[name], proto, offset, buffer, protos);\n            }\n          break;\n        }\n      }\n    }\n\n    return offset;\n  }\n\n  function encodeProp(value, type, offset, buffer, protos){\n    switch(type){\n      case 'uInt32':\n        offset = writeBytes(buffer, offset, codec.encodeUInt32(value));\n      break;\n      case 'int32' :\n      case 'sInt32':\n        offset = writeBytes(buffer, offset, codec.encodeSInt32(value));\n      break;\n      case 'float':\n        writeBytes(buffer, offset, codec.encodeFloat(value));\n        offset += 4;\n      break;\n      case 'double':\n        writeBytes(buffer, offset, codec.encodeDouble(value));\n        offset += 8;\n      break;\n      case 'string':\n        var length = codec.byteLength(value);\n\n        //Encode length\n        offset = writeBytes(buffer, offset, codec.encodeUInt32(length));\n        //write string\n        codec.encodeStr(buffer, offset, value);\n        offset += length;\n      break;\n      default :\n        var message = protos.__messages[type] || MsgEncoder.protos['message ' + type];\n        if(!!message){\n          //Use a tmp buffer to build an internal msg\n          var tmpBuffer = new ArrayBuffer(codec.byteLength(JSON.stringify(value))*2);\n          var length = 0;\n\n          length = encodeMsg(tmpBuffer, length, message, value);\n          //Encode length\n          offset = writeBytes(buffer, offset, codec.encodeUInt32(length));\n          //contact the object\n          for(var i = 0; i < length; i++){\n            buffer[offset] = tmpBuffer[i];\n            offset++;\n          }\n        }\n      break;\n    }\n\n    return offset;\n  }\n\n  /**\n   * Encode reapeated properties, simple msg and object are decode differented\n   */\n  function encodeArray(array, proto, offset, buffer, protos){\n    var i = 0;\n\n    if(util.isSimpleType(proto.type)){\n      offset = writeBytes(buffer, offset, encodeTag(proto.type, proto.tag));\n      offset = writeBytes(buffer, offset, codec.encodeUInt32(array.length));\n      for(i = 0; i < array.length; i++){\n        offset = encodeProp(array[i], proto.type, offset, buffer);\n      }\n    }else{\n      for(i = 0; i < array.length; i++){\n        offset = writeBytes(buffer, offset, encodeTag(proto.type, proto.tag));\n        offset = encodeProp(array[i], proto.type, offset, buffer, protos);\n      }\n    }\n\n    return offset;\n  }\n\n  function writeBytes(buffer, offset, bytes){\n    for(var i = 0; i < bytes.length; i++, offset++){\n      buffer[offset] = bytes[i];\n    }\n\n    return offset;\n  }\n\n  function encodeTag(type, tag){\n    var value = constant.TYPES[type]||2;\n\n    return codec.encodeUInt32((tag<<3)|value);\n  }\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\n\n/**\n * decoder module\n */\n(function (exports, global){\n  var protobuf = exports;\n  var MsgDecoder = exports.decoder = {};\n\n  var codec = protobuf.codec;\n  var util = protobuf.util;\n\n  var buffer;\n  var offset = 0;\n\n  MsgDecoder.init = function(protos){\n    this.protos = protos || {};\n  };\n\n  MsgDecoder.setProtos = function(protos){\n    if(!!protos){\n      this.protos = protos;\n    }\n  };\n\n  MsgDecoder.decode = function(route, buf){\n    var protos = this.protos[route];\n\n    buffer = buf;\n    offset = 0;\n\n    if(!!protos){\n      return decodeMsg({}, protos, buffer.length);\n    }\n\n    return null;\n  };\n\n  function decodeMsg(msg, protos, length){\n    while(offset<length){\n      var head = getHead();\n      var type = head.type;\n      var tag = head.tag;\n      var name = protos.__tags[tag];\n\n      switch(protos[name].option){\n        case 'optional' :\n        case 'required' :\n          msg[name] = decodeProp(protos[name].type, protos);\n        break;\n        case 'repeated' :\n          if(!msg[name]){\n            msg[name] = [];\n          }\n          decodeArray(msg[name], protos[name].type, protos);\n        break;\n      }\n    }\n\n    return msg;\n  }\n\n  /**\n   * Test if the given msg is finished\n   */\n  function isFinish(msg, protos){\n    return (!protos.__tags[peekHead().tag]);\n  }\n  /**\n   * Get property head from protobuf\n   */\n  function getHead(){\n    var tag = codec.decodeUInt32(getBytes());\n\n    return {\n      type : tag&0x7,\n      tag : tag>>3\n    };\n  }\n\n  /**\n   * Get tag head without move the offset\n   */\n  function peekHead(){\n    var tag = codec.decodeUInt32(peekBytes());\n\n    return {\n      type : tag&0x7,\n      tag : tag>>3\n    };\n  }\n\n  function decodeProp(type, protos){\n    switch(type){\n      case 'uInt32':\n        return codec.decodeUInt32(getBytes());\n      case 'int32' :\n      case 'sInt32' :\n        return codec.decodeSInt32(getBytes());\n      case 'float' :\n        var float = codec.decodeFloat(buffer, offset);\n        offset += 4;\n        return float;\n      case 'double' :\n        var double = codec.decodeDouble(buffer, offset);\n        offset += 8;\n        return double;\n      case 'string' :\n        var length = codec.decodeUInt32(getBytes());\n\n        var str =  codec.decodeStr(buffer, offset, length);\n        offset += length;\n\n        return str;\n      default :\n        var message = protos && (protos.__messages[type] || MsgDecoder.protos['message ' + type]);\n        if(!!message){\n          var length = codec.decodeUInt32(getBytes());\n          var msg = {};\n          decodeMsg(msg, message, offset+length);\n          return msg;\n        }\n      break;\n    }\n  }\n\n  function decodeArray(array, type, protos){\n    if(util.isSimpleType(type)){\n      var length = codec.decodeUInt32(getBytes());\n\n      for(var i = 0; i < length; i++){\n        array.push(decodeProp(type));\n      }\n    }else{\n      array.push(decodeProp(type, protos));\n    }\n  }\n\n  function getBytes(flag){\n    var bytes = [];\n    var pos = offset;\n    flag = flag || false;\n\n    var b;\n\n    do{\n      b = buffer[pos];\n      bytes.push(b);\n      pos++;\n    }while(b >= 128);\n\n    if(!flag){\n      offset = pos;\n    }\n    return bytes;\n  }\n\n  function peekBytes(){\n    return getBytes(true);\n  }\n\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\n\nvar pomelo = function() {\n  var JS_WS_CLIENT_TYPE = 'js-websocket';\n  var JS_WS_CLIENT_VERSION = '0.0.1';\n\n  var Protocol = window.Protocol;\n  var protobuf = window.protobuf;\n  var decodeIO_protobuf = window.decodeIO_protobuf;\n  var decodeIO_encoder = null;\n  var decodeIO_decoder = null;\n  var Package = Protocol.Package;\n  var Message = Protocol.Message;\n  var EventEmitter = window.EventEmitter;\n  var rsa = window.rsa;\n  var disconnectCb = null;\n\n  if(typeof(window) != \"undefined\" && typeof(sys) != 'undefined' && sys.localStorage) {\n    window.localStorage = sys.localStorage;\n  }\n  \n  var RES_OK = 200;\n  var RES_FAIL = 500;\n  var RES_OLD_CLIENT = 501;\n\n  if (typeof Object.create !== 'function') {\n    Object.create = function (o) {\n      function F() {}\n      F.prototype = o;\n      return new F();\n    };\n  }\n\n  var root = window;\n  var pomelo = Object.create(EventEmitter.prototype); // object extend from object\n  // root.pomelo = pomelo;\n  var socket = null;\n  var reqId = 0;\n  var callbacks = {};\n  var handlers = {};\n  //Map from request id to route\n  var routeMap = {};\n  var dict = {};    // route string to code\n  var abbrs = {};   // code to route string\n  var serverProtos = {};\n  var clientProtos = {};\n  var protoVersion = 0;\n\n  var heartbeatInterval = 0;\n  var heartbeatTimeout = 0;\n  var nextHeartbeatTimeout = 0;\n  var gapThreshold = 100;   // heartbeat gap threashold\n  var heartbeatId = null;\n  var heartbeatTimeoutId = null;\n  var handshakeCallback = null;\n\n  var decode = null;\n  var encode = null;\n\n  var reconnect = false;\n  var reconncetTimer = null;\n  var reconnectUrl = null;\n  var reconnectAttempts = 0;\n  var reconnectionDelay = 5000;\n  var DEFAULT_MAX_RECONNECT_ATTEMPTS = 10;\n\n  var useCrypto;\n\n  var handshakeBuffer = {\n    'sys': {\n      type: JS_WS_CLIENT_TYPE,\n      version: JS_WS_CLIENT_VERSION,\n      rsa: {}\n    },\n    'user': {\n    }\n  };\n\n  var initCallback = null;\n\n  pomelo.init = function(params, cb) {\n    initCallback = cb;\n    var host = params.host;\n    var port = params.port;\n\n    encode = params.encode || defaultEncode;\n    decode = params.decode || defaultDecode;\n\n    var wsType = params.wsType+'://' || 'ws://';\n\n    var url = wsType + host;\n    if(port) {\n      url +=  ':' + port;\n    }\n\n    handshakeBuffer.user = params.user;\n    if(params.encrypt) {\n      useCrypto = true;\n      rsa.generate(1024, \"10001\");\n      var data = {\n        rsa_n: rsa.n.toString(16),\n        rsa_e: rsa.e\n      }\n      handshakeBuffer.sys.rsa = data;\n    }\n    handshakeCallback = params.handshakeCallback;\n    connect(params, url, cb);\n  };\n\n  var defaultDecode = pomelo.decode = function(data) {\n    //probuff decode\n    var msg = Message.decode(data);\n\n    if(msg.id > 0){\n      msg.route = routeMap[msg.id];\n      delete routeMap[msg.id];\n      if(!msg.route){\n        return;\n      }\n    }\n\n    msg.body = deCompose(msg);\n    return msg;\n  };\n\n  var defaultEncode = pomelo.encode = function(reqId, route, msg) {\n    var type = reqId ? Message.TYPE_REQUEST : Message.TYPE_NOTIFY;\n\n    //compress message by protobuf\n    if(protobuf && clientProtos[route]) {\n      msg = protobuf.encode(route, msg);\n    } else if(decodeIO_encoder && decodeIO_encoder.lookup(route)) {\n      var Builder = decodeIO_encoder.build(route);\n      msg = new Builder(msg).encodeNB();\n    } else {\n      msg = Protocol.strencode(JSON.stringify(msg));\n    }\n\n    var compressRoute = 0;\n    if(dict && dict[route]) {\n      route = dict[route];\n      compressRoute = 1;\n    }\n\n    return Message.encode(reqId, type, compressRoute, route, msg);\n  };\n\n  var connect = function(params, url, cb) {\n    console.log('connect to ' + url);\n\n    var params = params || {};\n    var maxReconnectAttempts = params.maxReconnectAttempts || DEFAULT_MAX_RECONNECT_ATTEMPTS;\n    reconnectUrl = url;\n    //Add protobuf version\n    if(window.localStorage && window.localStorage.getItem('protos') && protoVersion === 0) {\n      var protos = JSON.parse(window.localStorage.getItem('protos'));\n\n      protoVersion = protos.version || 0;\n      serverProtos = protos.server || {};\n      clientProtos = protos.client || {};\n\n      if(!!protobuf) {\n        protobuf.init({encoderProtos: clientProtos, decoderProtos: serverProtos});\n      } \n      if(!!decodeIO_protobuf) {\n        decodeIO_encoder = decodeIO_protobuf.loadJson(clientProtos);\n        decodeIO_decoder = decodeIO_protobuf.loadJson(serverProtos);\n      }\n    }\n    //Set protoversion\n    handshakeBuffer.sys.protoVersion = protoVersion;\n\n    var onopen = function(event) {\n      if(!!reconnect) {\n        pomelo.emit('reconnect');\n      }\n      reset();\n      var obj = Package.encode(Package.TYPE_HANDSHAKE, Protocol.strencode(JSON.stringify(handshakeBuffer)));\n      send(obj);\n    };\n    var onmessage = function(event) {\n      processPackage(Package.decode(event.data), cb);\n      // new package arrived, update the heartbeat timeout\n      if(heartbeatTimeout) {\n        nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\n      }\n    };\n    var onerror = function(event) {\n      pomelo.emit('io-error', event);\n      console.error('socket error: ', event);\n    };\n    var onclose = function(event) {\n      pomelo.emit('close',event);\n      pomelo.emit('disconnect', event);\n      console.error('socket close: ', event);\n      if(!!params.reconnect && reconnectAttempts < maxReconnectAttempts) {\n        reconnect = true;\n        reconnectAttempts++;\n        reconncetTimer = setTimeout(function() {\n          connect(params, reconnectUrl, cb);\n        }, reconnectionDelay);\n        reconnectionDelay *= 2;\n      }\n      socket = null;\n      disconnectCb && disconnectCb();\n      disconnectCb = null;\n    };\n    socket = new WebSocket(url);\n    socket.binaryType = 'arraybuffer';\n    socket.onopen = onopen;\n    socket.onmessage = onmessage;\n    socket.onerror = onerror;\n    socket.onclose = onclose;\n  };\n\n  pomelo.disconnect = function(cb) {\n    disconnectCb = cb;\n    if(socket) {\n      if(socket.disconnect) socket.disconnect();\n      if(socket.close) socket.close();\n      console.log('disconnect');\n      socket = null;\n    }\n\n    if(heartbeatId) {\n      clearTimeout(heartbeatId);\n      heartbeatId = null;\n    }\n    if(heartbeatTimeoutId) {\n      clearTimeout(heartbeatTimeoutId);\n      heartbeatTimeoutId = null;\n    }\n  };\n\n  var reset = function() {\n    reconnect = false;\n    reconnectionDelay = 1000 * 5;\n    reconnectAttempts = 0;\n    clearTimeout(reconncetTimer);\n  };\n\n  pomelo.request = function(route, msg, cb) {\n    if(arguments.length === 2 && typeof msg === 'function') {\n      cb = msg;\n      msg = {};\n    } else {\n      msg = msg || {};\n    }\n    route = route || msg.route;\n    if(!route) {\n      return;\n    }\n\n    reqId++;\n    sendMessage(reqId, route, msg);\n\n    callbacks[reqId] = cb;\n    routeMap[reqId] = route;\n  };\n\n  pomelo.notify = function(route, msg) {\n    msg = msg || {};\n    sendMessage(0, route, msg);\n  };\n\n  var sendMessage = function(reqId, route, msg) {\n    if(useCrypto) {\n      msg = JSON.stringify(msg);\n      var sig = rsa.signString(msg, \"sha256\");\n      msg = JSON.parse(msg);\n      msg['__crypto__'] = sig;\n    }\n\n    if(encode) {\n      msg = encode(reqId, route, msg);\n    }\n\n    var packet = Package.encode(Package.TYPE_DATA, msg);\n    send(packet);\n  };\n\n  var send = function(packet) {\n    if (socket !== null) {\n        socket.send(packet.buffer);\n    }\n  };\n\n  var handler = {};\n\n  var heartbeat = function(data) {\n    if(!heartbeatInterval) {\n      // no heartbeat\n      return;\n    }\n\n    var obj = Package.encode(Package.TYPE_HEARTBEAT);\n    if(heartbeatTimeoutId) {\n      clearTimeout(heartbeatTimeoutId);\n      heartbeatTimeoutId = null;\n    }\n\n    if(heartbeatId) {\n      // already in a heartbeat interval\n      return;\n    }\n    heartbeatId = setTimeout(function() {\n      heartbeatId = null;\n      send(obj);\n\n      nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, heartbeatTimeout);\n    }, heartbeatInterval);\n  };\n\n  var heartbeatTimeoutCb = function() {\n    var gap = nextHeartbeatTimeout - Date.now();\n    if(gap > gapThreshold) {\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, gap);\n    } else {\n      console.error('server heartbeat timeout');\n      pomelo.emit('heartbeat timeout');\n      pomelo.disconnect();\n    }\n  };\n\n  var handshake = function(data) {\n    data = JSON.parse(Protocol.strdecode(data));\n    if(data.code === RES_OLD_CLIENT) {\n      pomelo.emit('error', 'client version not fullfill');\n      return;\n    }\n\n    if(data.code !== RES_OK) {\n      pomelo.emit('error', 'handshake fail');\n      return;\n    }\n\n    handshakeInit(data);\n\n    var obj = Package.encode(Package.TYPE_HANDSHAKE_ACK);\n    send(obj);\n    if(initCallback) {\n      initCallback(socket);\n    }\n  };\n\n  var onData = function(data) {\n    var msg = data;\n    if(decode) {\n      msg = decode(msg);\n    }\n    processMessage(pomelo, msg);\n  };\n\n  var onKick = function(data) {\n    data = JSON.parse(Protocol.strdecode(data));\n    pomelo.emit('onKick', data);\n  };\n\n  handlers[Package.TYPE_HANDSHAKE] = handshake;\n  handlers[Package.TYPE_HEARTBEAT] = heartbeat;\n  handlers[Package.TYPE_DATA] = onData;\n  handlers[Package.TYPE_KICK] = onKick;\n\n  var processPackage = function(msgs) {\n    if(Array.isArray(msgs)) {\n      for(var i=0; i<msgs.length; i++) {\n        var msg = msgs[i];\n        handlers[msg.type](msg.body);\n      }\n    } else {\n      handlers[msgs.type](msgs.body);\n    }\n  };\n\n  var processMessage = function(pomelo, msg) {\n    if(!msg.id) {\n      // server push message\n      pomelo.emit(msg.route, msg.body);\n      return;\n    }\n\n    //if have a id then find the callback function with the request\n    var cb = callbacks[msg.id];\n\n    delete callbacks[msg.id];\n    if(typeof cb !== 'function') {\n      return;\n    }\n\n    cb(msg.body);\n    return;\n  };\n\n  var processMessageBatch = function(pomelo, msgs) {\n    for(var i=0, l=msgs.length; i<l; i++) {\n      processMessage(pomelo, msgs[i]);\n    }\n  };\n\n  var deCompose = function(msg) {\n    var route = msg.route;\n\n    //Decompose route from dict\n    if(msg.compressRoute) {\n      if(!abbrs[route]){\n        return {};\n      }\n\n      route = msg.route = abbrs[route];\n    }\n    if(protobuf && serverProtos[route]) {\n      return protobuf.decode(route, msg.body);\n    } else if(decodeIO_decoder && decodeIO_decoder.lookup(route)) {\n      return decodeIO_decoder.build(route).decode(msg.body);\n    } else {\n      return JSON.parse(Protocol.strdecode(msg.body));\n    }\n\n    return msg;\n  };\n\n  var handshakeInit = function(data) {\n    if(data.sys && data.sys.heartbeat) {\n      heartbeatInterval = data.sys.heartbeat * 1000;   // heartbeat interval\n      heartbeatTimeout = heartbeatInterval * 2;        // max heartbeat timeout\n    } else {\n      heartbeatInterval = 0;\n      heartbeatTimeout = 0;\n    }\n\n    initData(data);\n\n    if(typeof handshakeCallback === 'function') {\n      handshakeCallback(data.user);\n    }\n  };\n\n  //Initilize data used in pomelo client\n  var initData = function(data) {\n    if(!data || !data.sys) {\n      return;\n    }\n    dict = data.sys.dict;\n    var protos = data.sys.protos;\n\n    //Init compress dict\n    if(dict) {\n      dict = dict;\n      abbrs = {};\n\n      for(var route in dict) {\n        abbrs[dict[route]] = route;\n      }\n    }\n\n    //Init protobuf protos\n    if(protos) {\n      protoVersion = protos.version || 0;\n      serverProtos = protos.server || {};\n      clientProtos = protos.client || {};\n\n        //Save protobuf protos to localStorage\n        window.localStorage.setItem('protos', JSON.stringify(protos));\n\n        if(!!protobuf) {\n          protobuf.init({encoderProtos: protos.client, decoderProtos: protos.server});\n        }\n        if(!!decodeIO_protobuf) {\n          decodeIO_encoder = decodeIO_protobuf.loadJson(clientProtos);\n          decodeIO_decoder = decodeIO_protobuf.loadJson(serverProtos);\n        }\n      }\n    };\n    return pomelo;\n  };\n // window.pomelo=new cc.Pomelo();\n// export default pomelo;\nmodule.exports = pomelo;\n\n\n\n\n"]}