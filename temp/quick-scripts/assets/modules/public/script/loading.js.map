{"version":3,"sources":["loading.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\modules\\public\\script","sourcesContent":["import BaseModel from \"../../../framework/baseClass/BaseModel\";\r\nimport BaseView from \"../../../framework/baseClass/BaseView\";\r\nimport BaseCtrl from \"../../../framework/baseClass/BaseCtrl\";\r\nimport Loader from \"../../../framework/modules/Loader\";\r\nimport GameNet from \"../../../framework/modules/GameNet\";\r\n\r\n/*\r\nauthor: 张志强\r\n日期:2018-11-05 15:03:40\r\n*/\r\n\r\n//MVC模块,\r\nconst { ccclass, property } = cc._decorator;\r\nlet ctrl: LoadingCtrl;\r\n//模型，数据处理\r\nclass Model extends BaseModel {\r\n\tpublic routeArr: string[] = null;\r\n\tpublic totalRouteLen: number = 0;\r\n\tpublic curRouteLen: number = 0;\r\n\tpublic curResPaths: any = null;\r\n\tpublic curProgress: number = 0;\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t}\r\n\r\n\tpublic setRouteArr(arr: string[]): void {\r\n\t\tthis.routeArr = arr;\r\n\t\tthis.totalRouteLen = arr.length;\r\n\t}\r\n\r\n\tpublic setResPaths(obj: any): void {\r\n\t\tthis.curResPaths = obj;\r\n\t}\r\n\r\n\tpublic routeReceived(): void {\r\n\t\tthis.curRouteLen += 1;\r\n\t}\r\n\r\n\tpublic addProgress(p: number): void {\r\n\t\tthis.curProgress += p;\r\n\t}\r\n}\r\n//视图, 界面显示或动画，在这里完成\r\nclass View extends BaseView {\r\n\tprotected model: Model;\r\n\tprotected node: cc.Node;\r\n\tpublic ui = {\r\n\t\t//在这里声明ui\r\n\t\tprogressBar: ctrl.progressBar\r\n\t}\r\n\tconstructor(model) {\r\n\t\tsuper(model);\r\n\t\tthis.node = ctrl.node;\r\n\t\tthis.initUi();\r\n\t}\r\n\t//初始化ui\r\n\tpublic initUi() {\r\n\t\tthis.addGrayLayer(false);\r\n\t}\r\n\r\n\tpublic refreshProgress() {\r\n\t\tthis.ui.progressBar.progress = this.model.curProgress;\r\n\t}\r\n}\r\n//c, 控制\r\n@ccclass\r\nexport default class LoadingCtrl extends BaseCtrl {\r\n\tprotected view: View;\r\n\tprotected model: Model;\r\n\t//这边去声明ui组件\r\n\t@property(cc.ProgressBar)\r\n\tprogressBar: cc.ProgressBar = null;\r\n\t//声明ui组件end\r\n\t//这是ui组件的map,将ui和控制器或试图普通变量分离\r\n\tprivate _completeCB: Function = null;\r\n\tpublic needLoadData: boolean = false;\r\n\r\n\tprotected onLoad(): void {\r\n\t\t// 控制器\r\n\t\tctrl = this;\r\n\t\t// 创建mvc模式中模型和视图\r\n\t\tthis.initMvc(Model, View);\r\n\t}\r\n\r\n\t//定义网络事件\r\n\tprotected defineNetEvents(): void {\r\n\t\tthis.n_events = {};\r\n\t}\r\n\t//定义全局事件\r\n\tprotected defineGlobalEvents(): void {\r\n\t\tthis.g_events = {};\r\n\t}\r\n\t//绑定操作的回调\r\n\tprotected connectUi(): void {\r\n\r\n\t}\r\n\t// 网络事件回调begin\r\n\tpublic routeReceived(): void {\r\n\t\tthis.model.routeReceived();\r\n\t\tlet num = this.model.curRouteLen / this.model.totalRouteLen;\r\n\t\tthis.addProgress(num);\r\n\t\tif (num >= 1) this._complete();\r\n\t}\r\n\t// end\r\n\t// 全局事件回调begin\r\n\t// end\r\n\t// 按钮或任何控件操作的回调begin\r\n\t// end\r\n\tpublic setPreLoad(obj: any): void {\r\n\t\tlet { resPaths, routeArr, complete } = obj;\r\n\t\tthis.model.setResPaths(resPaths);\r\n\t\tif (routeArr) {\r\n\t\t\tlet len = routeArr.length;\r\n\t\t\tfor (let i = 0; i < len; ++i) {\r\n\t\t\t\tthis.n_events[routeArr[i]] = this.routeReceived;\r\n\t\t\t}\r\n\t\t\tthis.regAllEvents();\r\n\t\t\tthis.model.setRouteArr(routeArr);\r\n\t\t\tthis.needLoadData = true;\r\n\t\t}\r\n\t\tthis._completeCB = complete;\r\n\t\tthis._preLoadRes();\r\n\t}\r\n\r\n\tprivate _preLoadData() {\r\n\t\tfor (let i = 0; i < this.model.totalRouteLen; ++i) {\r\n\t\t\tGameNet.getInstance().send_msg(this.model.routeArr[i]);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate _preLoadRes(): void {\r\n\t\tlet paths = [];\r\n\t\tfor (let k in this.model.curResPaths) {\r\n\t\t\tlet type = null;\r\n\t\t\tswitch (k) {\r\n\t\t\t\tcase \"prefab\": type = cc.Prefab; break;\r\n\t\t\t\tcase \"image\": type = cc.SpriteFrame; break;\r\n\t\t\t\tcase \"config\": type = cc.JsonAsset; break;\r\n\t\t\t}\r\n\t\t\tfor (let s in this.model.curResPaths[k]) {\r\n\t\t\t\tpaths.push({ url: this.model.curResPaths[k][s], type: type });\r\n\t\t\t}\r\n\t\t}\r\n\t\tLoader.getInstance().loadQueue({\r\n\t\t\tpaths: paths,\r\n\t\t\tprogress: (num: Number) => {\r\n\t\t\t\tthis.addProgress(num)\r\n\t\t\t},\r\n\t\t\tcomplete: () => {\r\n\t\t\t\tif (this.needLoadData) {\r\n\t\t\t\t\tthis._preLoadData();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis._complete();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tpublic addProgress(num): void {\r\n\t\tif (this.needLoadData) num /= 2;\r\n\t\tthis.model.addProgress(num)\r\n\t\tthis.view.refreshProgress();\r\n\t}\r\n\r\n\tprivate _complete(): void {\r\n\t\tthis.remove();\r\n\t\tthis._completeCB();\r\n\t}\r\n\r\n\t// update(dt) {}\r\n\r\n\tprotected onDestroy(): void {\r\n\t\tsuper.onDestroy();\r\n\t}\r\n}"]}