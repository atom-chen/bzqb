{"version":3,"sources":["ServerMgr.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\assets\\framework\\modules","sourcesContent":["import Loader from \"../modules/Loader\";\r\nimport GameNet from \"../modules/GameNet\";\r\n\r\nexport default class ServerMgr {\r\n    //单例处理 \r\n    private static _instance: ServerMgr = new ServerMgr();\r\n    public static getInstance(): ServerMgr {\r\n        return this._instance;\r\n    }\r\n    private _settingPath: string = 'config/localsetting';\r\n    private _localsetting: any = null;\r\n    private _servercfg: any = null;\r\n    private _callback: Function = null;\r\n    private _enableHotUpdate: boolean = false;\r\n\r\n    constructor() {\r\n        this._enableHotUpdate = cc.sys.isNative && cc.sys.isMobile;\r\n    }\r\n\r\n    public loadLoacalSetting(callback: Function): void {\r\n        this._callback = callback;\r\n        this._localsetting = Loader.getInstance().getRes(this._settingPath, cc.JsonAsset).json;\r\n        this.loadSettingCb();\r\n    }\r\n\r\n    public loadSettingCb(): void {\r\n        let xhr = cc.loader.getXMLHttpRequest();\r\n        xhr.onreadystatechange = () => {\r\n            if (xhr.readyState === 4 && (xhr.status >= 200 && xhr.status < 300)) {\r\n                let respone = xhr.responseText;\r\n                this._servercfg = JSON.parse(respone);\r\n                console.log(\"网络配置=\", this._servercfg);\r\n                GameNet.getInstance().setServerCfg();\r\n                this._callback(0);\r\n            }\r\n        };\r\n        xhr.timeout = 3000;\r\n        xhr.onerror = () => {\r\n            console.error(\"下载网络配置出错!\");\r\n            this._callback(-1);\r\n        }\r\n        xhr.ontimeout = () => {\r\n            console.error(\"下载网络配置超时!\");\r\n            this._callback(-1);\r\n        }\r\n        let URLProducttag = this._localsetting.producttag;\r\n        if (!cc.sys.isNative && window && window.location && window.location.href) {\r\n            URLProducttag = this.analysisURLParameter(window.location.href).args.producttag;\r\n            // console.log(\"URLProducttag=\", URLProducttag, data.producttag);\r\n        }\r\n        window['__errorReportUrl'] = `${this._localsetting.cfgurl}:10001`;//错误报告地址\r\n        if (!window['__errorUserInfo']) {\r\n            window['__errorUserInfo'] = {};\r\n        }\r\n        window['__errorUserInfo']['tag'] = this._localsetting.producttag;\r\n        let wholeurl = `${this._localsetting.cfgurl}/${URLProducttag || this._localsetting.producttag}.json`\r\n        // console.log(\"wholeurl=\", wholeurl);\r\n        xhr.open(\"GET\", wholeurl, true);\r\n        xhr.send();\r\n    }\r\n    // 解析URL是否带调试参数\r\n    public analysisURLParameter(URL: string): any {\r\n        let arr = URL.split(\"?\")\r\n        let obj = {\r\n            url: null,\r\n            args: {}\r\n        };\r\n        obj.url = arr[0];\r\n        // 拆分后如果长度小于2说明URL是不带参数的\r\n        if (arr.length < 2) return obj;\r\n        let mapArr = arr[1].split(\"&\");\r\n        for (let i = 0; i < mapArr.length; i++) {\r\n            let parameter = mapArr[i].split(\"=\");\r\n            obj.args[parameter[0]] = parameter[1];\r\n        }\r\n        // console.log(\"解析URL\", obj)\r\n        return obj\r\n    }\r\n\r\n    public getProductTag(): string {\r\n        return this._localsetting.producttag;\r\n    }\r\n\r\n    public isEnableHotUpdate(): boolean {\r\n        return this._enableHotUpdate;\r\n    }\r\n\r\n    public getServerCfg(): any {\r\n        return this._servercfg;\r\n    }\r\n\r\n    public getHotupdateVersionUrl(): string {\r\n        return `${this._servercfg.hotUrl}`;\r\n    }\r\n}\r\n"]}